<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard – Projetos</title>
  <style>
    :root{
      /* Light theme */
      --bg:#F7F9FC;           /* página */
      --card:#FFFFFF;         /* cards/tabelas */
      --surface-2:#F1F5F9;    /* superfícies internas */
      --stroke:#E5E7EB;       /* bordas */
      --text:#0F172A;         /* texto principal */
      --muted:#475569;        /* texto secundário */

      /* Semânticas */
      --ok:#00A443;           /* Concluído */
      --warn:#F68C1B;         /* Fora do fluxo / Urgente */
      --danger:#EF4444;       /* Atrasos / Crítico */
      --primary:#2CB6FF;      /* Prioridade / CTAs */

      /* Auxiliares */
      --accent:#2CB6FF;       /* gradientes leves */
      --accent-2:#2CB6FF;     /* botão principal */
      --chip:#F1F5F9;
      --focus:#7C3AED;        /* foco acessível */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; line-height:1.5}
    :focus-visible{outline:2px solid var(--focus); outline-offset:3px; border-radius:8px}

    header{padding:20px; border-bottom:1px solid var(--stroke); display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; background:var(--card)}
    .brand{display:flex; align-items:center; gap:10px}
    .brand h1{font-size:18px; margin:0}
    .actions{display:flex; gap:8px; flex-wrap:wrap}

    .btn{background:var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer}
    .btn.secondary{background:var(--card); color:var(--text); border:1px solid var(--stroke)}

    .file-wrap{position:relative}
    input[type=file]{position:absolute; inset:0; opacity:0; cursor:pointer}
    .file-label{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; background:var(--primary); color:#fff; border:none; font-weight:700; cursor:pointer}

    main{padding:22px; max-width:1400px; margin:0 auto}
    .grid{display:grid; gap:16px}
    .cols-2{grid-template-columns:repeat(2, minmax(0,1fr))}
    .cols-4{grid-template-columns:repeat(4, minmax(0,1fr))}
    .cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}
    @media (max-width:1100px){.cols-2{grid-template-columns:1fr}.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}.cols-5{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:680px){.cols-4{grid-template-columns:1fr}.cols-5{grid-template-columns:1fr}}

    .card{background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:16px}
    .card h2{margin:0 0 10px; font-size:16px; font-weight:700}
    .muted{color:var(--muted)}
    .row{display:flex; gap:8px; align-items:baseline; flex-wrap:wrap}
    .meta{font-size:13px;font-weight:500;color:var(--muted)}
    .meta::before{content:'·';margin:0 6px 0 2px;color:var(--muted)}

    .kpi{display:flex; align-items:baseline; justify-content:space-between; border-top:1px dashed var(--stroke); padding-top:10px; margin-top:10px}
    .kpi .big{font-size:28px; font-weight:800}

    .kanban-list{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:10px}
    @media (max-width:1100px){.kanban-list{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:680px){.kanban-list{grid-template-columns:1fr}}
    .tile{background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:12px}
    .tile .name{font-weight:700; margin:0 0 6px}
    .tile .bar{height:8px; background:#1c2330; border-radius:999px; overflow:hidden}
    .tile .fill{height:8px; background:linear-gradient(90deg, var(--accent-2), #8b5cf6)}
    .tile .foot{display:flex; justify-content:space-between; margin-top:6px; color:var(--muted); font-size:12px}

    .bars{display:flex; flex-direction:column; gap:10px; margin-top:6px}
    .bar-outer{height:12px; background:var(--surface-2); border:1px solid var(--stroke); border-radius:999px; overflow:hidden}
    .bar-inner{height:12px; background:linear-gradient(90deg, var(--primary), #7C3AED)}

    table{width:100%; border-collapse:collapse; margin-top:8px; font-size:14px}
    th, td{padding:10px 8px; border-bottom:1px solid var(--stroke); vertical-align:top}
    th{color:var(--muted); font-weight:600; text-align:left}
    tr:last-child td{border-bottom:none}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px; font-size:12px; background:var(--surface-2); border:1px solid var(--stroke); color:var(--muted)}
    .tag.ok{background:rgba(0,164,67,.12); color:var(--ok); border-color:rgba(0,164,67,.3)}
    .tag.warn{background:rgba(246,140,27,.15); color:var(--warn); border-color:rgba(246,140,27,.35)}
    .tag.danger{background:rgba(239,68,68,.15); color:var(--danger); border-color:rgba(239,68,68,.35)}
    .tag.info{background:rgba(44,182,255,.12); color:var(--primary); border-color:rgba(44,182,255,.3)}
    .hidden{display:none}

    .badge{display:inline-flex; align-items:center; gap:6px; padding:2px 6px; border-radius:999px; font-size:11px; background:#0f1722; border:1px solid var(--stroke); color:var(--muted)}
    .badge.new{background:rgba(96,165,250,.12); color:#93c5fd; border-color:rgba(96,165,250,.3)}
    .overcap{color:#fca5a5}
    .status-pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; background:var(--surface-2); border:1px solid var(--stroke); color:var(--muted)}
    .date.overdue{color:var(--danger);font-weight:700}
    .date.stale{color:var(--warn);font-weight:700}

  /* === Ajustes de layout dos KPIs (disposição e tamanho) === */
#kpis{grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px}
#kpis .card{padding:12px; border-radius:12px; min-height:116px}
#kpis .row{margin-bottom:4px}
#kpis .kpi{margin-top:8px; padding-top:8px}
#kpis .kpi .big{font-size:32px}
#kpis .kpi .muted{font-size:13px}

</style>
</head>
<body>
  <header>
    <div class="brand"></div>
    <div class="actions" role="group" aria-label="Carregar dados">
      <div class="file-wrap">
        <span id="fileLabel" class="file-label" aria-live="polite">Carregar JSON</span>
        <input id="fileInput" type="file" accept=".json,application/json" aria-describedby="fileHelp">
      </div>
      <span id="hdrStatus" class="status-pill">Pronto</span>
    </div>
  </header>

  <div id="msg" style="padding:10px 20px;color:var(--muted);background:var(--surface-2);border-bottom:1px solid var(--stroke);font-size:12px">Pronto para carregar um JSON do Trello…</div>
  <details id="dbg" style="margin:8px 22px"><summary style="cursor:pointer">Diagnóstico</summary>
    <pre id="dbgLog" style="white-space:pre-wrap; font-size:12px; color:var(--muted); background:#0e1116; border:1px solid var(--stroke); border-radius:10px; padding:10px; max-height:200px; overflow:auto"></pre>
  </details>

  <main id="mainContent" class="grid cols-2">

    <!-- KPIs -->
    <section id="kpis" class="grid cols-5" aria-label="KPIs"></section>

    <!-- Fora do fluxo -->
    <section class="card" style="grid-column:1 / -1" aria-labelledby="out-h2">
      <div class="row"><h2 id="out-h2">Fora do fluxo</h2><span class="meta">Neoenergia</span></div>
      <div id="kanban-out" class="grid cols-4" role="list"></div>
    </section>

    <!-- Pré-projeto -->
    <section class="card" style="grid-column:1 / -1" aria-labelledby="pre-h2">
      <div class="row"><h2 id="pre-h2">Pré-projeto</h2><span class="meta">CSM Wittel</span></div>
      <div id="kanban-pre" class="grid cols-4" role="list"></div>
    </section>

    <!-- Projetos (execução) -->
    <section class="card" style="grid-column:1 / -1" aria-labelledby="exec-h2">
      <div class="row"><h2 id="exec-h2">Projetos (execução)</h2></div>
      <div id="kanban-exec" class="grid cols-4" role="list"></div>
    </section>

    <!-- CX -->
    <section class="card" style="grid-column:1 / -1" aria-labelledby="cx-h2">
      <div class="row"><h2 id="cx-h2">CX</h2></div>
      <div id="kanban-cx" class="grid cols-4" role="list"></div>
    </section>

    <!-- Membros -->
    <section class="card" style="grid-column:1 / -1" aria-labelledby="members-h2">
      <div class="row"><h2 id="members-h2">Membros</h2></div>
      <div id="members" class="bars"></div>
    </section>

    <!-- Tabela de projetos -->
    <section class="card" style="grid-column:1 / -1" aria-labelledby="projetos-h2">
      <div class="row"><h2 id="projetos-h2">Projetos (Progresso %)</h2></div>
      <div class="row" style="justify-content:flex-end; align-items:center">
        <div class="muted">Total: <span id="totalRows">0</span></div>
      </div>
      <table id="projects" class="table-sticky">
        <thead>
          <tr>
            <th data-sort="name">Projeto</th>
            <th data-sort="list">Lista</th>
            <th data-sort="owner">Responsável</th>
            <th data-sort="due">Entrega</th>
            <th data-sort="finalDue">Entrega Final</th>
            <th data-sort="puc">PUC</th>
            <th class="right" data-sort="progress" style="cursor:pointer" title="Ordenar por Progresso">Progresso ▲▼</th>
            <th data-sort="updatedAt">Atualizado</th>
            <th data-sort="url">Card</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

  </main>

  <footer style="padding:18px 22px; border-top:1px solid var(--stroke); color:var(--muted); display:flex; justify-content:space-between; flex-wrap:wrap; gap:12px">
    <span>Dashboard local – seus dados não saem do navegador.</span>
    <span>Carregue um export JSON do Trello.</span>
  </footer>

<script>
"use strict";
// ===== Helpers =====
function $(sel,root){return (root||document).querySelector(sel);} 
function $$(sel,root){return Array.from((root||document).querySelectorAll(sel));}
function logd(){var s=Array.from(arguments).map(function(x){try{return typeof x==='string'?x:JSON.stringify(x);}catch(_){return String(x);}}).join(' '); var el=$('#dbgLog'); if(el){el.textContent+=s+'\n'; el.scrollTop=el.scrollHeight;} if(window.console&&console.debug){console.debug('[DBG]',s);} }
function setMsg(t){ var el=$('#msg'); if(el){ el.textContent=t; } var hs=$('#hdrStatus'); if(hs){ hs.textContent=t; } }

function stripAccents(s){return s? s.normalize('NFD').replace(/[\u0300-\u036f]/g,''):'';}
function norm(s){s=String(s||'').trim(); s=s.replace(/\s+/g,' '); var k=stripAccents(s).toLowerCase(); if(k==='acompanha resultado'||k==='acompanha resultados') return 'acompanha resultados'; if(k==='concluido'||k==='concluído') return 'concluido'; if(k==='painel') return 'painel'; if(k==='backlog') return 'backlog'; if(k==='suspenso') return 'suspenso'; if(k==='cancelado') return 'cancelado'; return k;}
function renderLabel(key){if(key==='acompanha resultados') return 'Acompanha Resultados'; if(key==='concluido') return 'Concluído'; if(key==='painel') return 'Painel'; if(key==='backlog') return 'Backlog'; if(key==='suspenso') return 'Suspenso'; if(key==='cancelado') return 'Cancelado'; return key.split(' ').map(function(w){var lows={de:1,da:1,do:1,dos:1,das:1,e:1,ou:1,em:1,no:1,na:1}; return lows[w]?w:(w.charAt(0).toUpperCase()+w.slice(1));}).join(' ');} 
function titleCaseLike(str){if(!str) return ''; var low=['de','da','do','dos','das','e','ou','em','no','na']; return String(str).split(' ').map(function(w){if(!w) return w; return low.indexOf(w.toLowerCase())>-1 ? w.toLowerCase() : (w.charAt(0).toUpperCase()+w.slice(1));}).join(' ');} 
function normalizeMember(raw){if(!raw) return '—'; var key=String(raw).trim(); return MEMBER_MAP.get(key)||titleCaseLike(key);} 
function fmtPct(n){if(isNaN(n)||n==null) return '—'; var v=Math.round(n*1000)/10; return (v.toFixed(1).replace('.0',''))+'%';}
function fmtDate(s){if(!s) return '—'; var d=new Date(s); if(isNaN(d)) return '—'; var dd=String(d.getDate()).padStart(2,'0'); var mm=String(d.getMonth()+1).padStart(2,'0'); var yyyy=d.getFullYear(); return dd+'/'+mm+'/'+yyyy;}
function tagForPUC(puc){ var v=String(puc||'').toLowerCase(); if(v==='crítico'||v==='critico') return '<span class="tag danger">Crítico</span>'; if(v==='urgente') return '<span class="tag warn">Urgente</span>'; if(v==='prioridade') return '<span class="tag info">Prioridade</span>'; return '<span class="tag">—</span>'; }
// Regra: atrasado = tem due no passado e não está finalizado nem fora do fluxo
function isOverdue(c){ try{ if(!c||!c.due) return false; if(DONE_LIST_KEYS.has(c.listKey)||OUT_OF_FLOW_KEYS.has(c.listKey)) return false; var d=new Date(c.due); if(isNaN(d)) return false; var today=new Date(); today.setHours(0,0,0,0); return d < today; }catch(_){ return false; } }
// Regra: atrasado (final) = possui finalDue no passado e não está finalizado
function isFinalOverdue(c){ try{ if(!c || !c.finalDue) return false; if (DONE_LIST_KEYS.has(c.listKey) || OUT_OF_FLOW_KEYS.has(c.listKey)) return false; var d = new Date(c.finalDue); if (isNaN(d)) return false; var today = new Date(); today.setHours(0,0,0,0); return d < today; }catch(_){ return false; } }

// ===== Config =====
var STALE_DAYS = 10; // 'Sem atualização' quando última atualização for há >= 10 dias
var ORDERED_ACTIVE_LABELS=[
  'Nova Demanda',
  'Estudo Téc/RN',
  'Levantamento de Esforço',
  'Aprovação de Esforço',
  'Planejamento',
  'Cronograma',
  'Debito Técnico',
  'Construção da EF',
  'Confirmação da EF (WTéc)',
  'Validação EF',
  'Pronto para DEV',
  'Dev',
  'QA Wittel',
  'Certificação',
  'Deploy'
];
var ORDERED_ACTIVE_KEYS=ORDERED_ACTIVE_LABELS.map(norm);
var OUT_OF_FLOW_KEYS=new Set(['Backlog','Suspenso','Cancelado'].map(norm));
var DONE_LIST_KEYS=new Set(['Concluído','Acompanha Resultados'].map(norm));
var EXCLUDE_FULL_LIST_KEYS=new Set(['Painel','Manual de Utilização'].map(norm));
var MEMBER_MAP=new Map([
  ['Beatriz Cristina Causs Barbieri','Beatriz Causs'],
  ['ricardo.michelin','Ricardo Michelin'],
  ['Renan mora rodrigues da silva','Renan Mora'],
  ['Nataly Rubi Cardoso','Nataly Cardoso'],
  ['mariany.felix','Mariany Felix'],
  ['patricia.tasseli','Patricia Tasseli']
]);

// members.json (opcional)
var CONFIG={aliases:{},teams:{},capacity:{}};
(function(){ try{ if(/^https?:/i.test(location.protocol)){ fetch('./members.json?nocache='+(Date.now()),{cache:'no-cache'}).then(function(r){ if(!r.ok) return null; return r.json(); }).then(function(j){ if(!j) return; CONFIG.aliases=j.aliases||{}; CONFIG.teams=j.teams||{}; CONFIG.capacity=j.capacity||{}; Object.keys(CONFIG.aliases).forEach(function(alias){ MEMBER_MAP.set(alias, CONFIG.aliases[alias]); }); setMsg('Config de membros carregada'); }).catch(function(){/* ignora */}); } }catch(_){/* ignora */} })();

// Util: extrai primeira data válida de um texto (DD/MM/AAAA ou AAAA-MM-DD)
function parseDateFromText(text){
  try{
    if(!text) return null; var s=String(text).trim();
    var parts = s.split(' ');
    for(var i=0;i<parts.length;i++){
      var t = parts[i]; if(!t) continue;
      if(t.indexOf('/')>-1){ var a=t.split('/'); if(a.length===3){ var d=parseInt(a[0],10), mo=parseInt(a[1],10)-1, y=parseInt(a[2],10); var dt=new Date(y,mo,d); if(!isNaN(dt)) return dt; } }
      if(t.indexOf('-')>-1){ var b=t.split('-'); if(b.length===3){ var y2=parseInt(b[0],10), mo2=parseInt(b[1],10)-1, d2=parseInt(b[2],10); var dt2=new Date(y2,mo2,d2); if(!isNaN(dt2)) return dt2; } }
    }
    return null;
  }catch(_){ return null; }
}

// ===== Parse Trello JSON =====
function ingestTrello(raw){
  try{
    var listsById=new Map();
    var membersById=new Map();
    var checkAgg=new Map();        // idCard -> {done,total}
    var finalDueByCard=new Map();  // idCard -> ISO string
    var cards=[];

    // --- Lists & Members
    if(Array.isArray(raw.lists)){
      raw.lists.forEach(function(l){ listsById.set(l.id,{id:l.id,name:String(l.name||'').trim(),closed:!!l.closed}); });
    }
    if(Array.isArray(raw.members)){
      raw.members.forEach(function(m){ var name=m.fullName||m.username||m.name||''; membersById.set(m.id, normalizeMember(name)); });
    }

    // --- Checklists (progresso + Data de Entrega)
    if(Array.isArray(raw.checklists)){
      raw.checklists.forEach(function(cl){
        var items=Array.isArray(cl.checkItems)? cl.checkItems : [];
        var done=items.filter(function(i){return String(i.state).toLowerCase()==='complete';}).length;
        var total=items.length;
        var cur=checkAgg.get(cl.idCard)||{done:0,total:0};
        checkAgg.set(cl.idCard,{done:cur.done+done,total:cur.total+total});
        var clKey=norm(cl.name||'');
        if(clKey.indexOf('data de entrega')>-1){
          var best=null;
          items.forEach(function(it){ var d=parseDateFromText(it && it.name); if(d){ if(!best || d>best) best=d; } });
          if(best) finalDueByCard.set(cl.idCard, best.toISOString());
        }
      });
    }

    // --- Cards
    var rawOpenCount = Array.isArray(raw.cards)? raw.cards.filter(function(c){return !c.closed;}).length : 0;
    if(Array.isArray(raw.cards)){
      cards=raw.cards.filter(function(c){return !c.closed;}).map(function(c){
        var list=listsById.get(c.idList);
        var rawListName = list? list.name : (c.listName||'');
        rawListName = String(rawListName||'').trim();
        // normaliza sinônimos de listas para os rótulos canônicos do Kanban
        (function(){
          var pairs = [
            ['Levantamento do Esforço','Levantamento de Esforço'],
            ['Aprovação do Esforço','Aprovação de Esforço'],
            ['Construção EF','Construção da EF'],
            ['Confirmacao da EF (WTec)','Confirmação da EF (WTéc)'],
            ['Confirmação EF (WTec)','Confirmação da EF (WTéc)'],
            ['Validacao EF','Validação EF'],
            ['A fazer','Nova Demanda'],
            ['A Fazer','Nova Demanda']
          ];
          var k = norm(rawListName);
          for (var i=0;i<pairs.length;i++){ if (norm(pairs[i][0])===k) { rawListName = pairs[i][1]; break; } }
        })();
        var listName = rawListName;
        var listKey = norm(listName);
        var puc=null;
        if(Array.isArray(c.labels)){
          var names=c.labels.map(function(l){return (l.name||'').toLowerCase();});
          if(names.indexOf('crítico')>-1||names.indexOf('critico')>-1) puc='Crítico';
          else if(names.indexOf('urgente')>-1) puc='Urgente';
          else if(names.indexOf('prioridade')>-1) puc='Prioridade';
        } else if(typeof c.puc==='string'){ puc=c.puc; }
        var owner='—';
        if(Array.isArray(c.idMembers) && c.idMembers.length){ var m=membersById.get(c.idMembers[0]); if(m) owner=m; }
        else if(c.member){ owner=normalizeMember(c.member); }
        var agg=checkAgg.get(c.id)||{done:0,total:0}; var progress=agg.total>0? (agg.done/agg.total):null;
        var finalDue=finalDueByCard.get(c.id)||null;
        var dueVal=c.due||c.dueDate||c.dataEntrega||null;
        var updatedAt = c.dateLastActivity || null; // somente atividade real
        try { if (updatedAt) { var u=new Date(updatedAt); var today=new Date(); today.setHours(0,0,0,0); if (u>today) updatedAt=today.toISOString(); } } catch(_) {}
        var url=c.url || (c.shortLink? ('https://trello.com/c/'+c.shortLink): null);
        return { id:c.id, name:String(c.name||'').trim(), list:listName, listKey:listKey, due:dueVal, finalDue:finalDue, owner:owner, puc:puc, progress:progress, updatedAt:updatedAt, url:url };
      });
    }

    // --- Regras de exclusão
    cards=cards.filter(function(c){ return !EXCLUDE_FULL_LIST_KEYS.has(c.listKey); });
    cards=cards.filter(function(c){ return norm(c.name) !== norm(c.list); }); // remove placeholders "nome == lista"

    return {cards:cards, rawOpenCount: rawOpenCount};
  }catch(err){ console.error('ingestTrello error:', err); throw err; }
}


// ===== Métricas & Render =====
function compute(cards, rawOpen){
  // Grupos
  var GROUP_OUT_LABELS = ['Backlog','Suspenso','Cancelado'];
  var GROUP_PRE_LABELS = ['Nova Demanda','Estudo Téc/RN','Levantamento de Esforço','Aprovação de Esforço'];
  var GROUP_EXEC_LABELS = ['Planejamento','Cronograma','Debito Técnico','Construção da EF','Confirmação da EF (WTéc)','Validação EF','Pronto para DEV','Dev','QA Wittel','Certificação','Deploy'];
  var GROUP_CX_LABELS  = ['Acompanha Resultados'];

  var totalValid=cards.length;
  var doneCount=cards.filter(function(c){return DONE_LIST_KEYS.has(c.listKey);}).length;

  // Kanban ativo (14 listas)
  var byList=new Map(ORDERED_ACTIVE_LABELS.map(function(s){return [norm(s),0];}));
  cards.forEach(function(c){ if(byList.has(c.listKey)){ byList.set(c.listKey,(byList.get(c.listKey)||0)+1); } });
  var activeCount = 0; byList.forEach(function(v){ activeCount += v||0; });

  function buildGroup(labels){ var m=new Map(labels.map(function(s){return [norm(s),0];})); cards.forEach(function(c){ if(m.has(c.listKey)){ m.set(c.listKey,(m.get(c.listKey)||0)+1); } }); return m; }
  var byOut = buildGroup(GROUP_OUT_LABELS);
  var byPre = buildGroup(GROUP_PRE_LABELS);
  var byExec = buildGroup(GROUP_EXEC_LABELS);
  var byCx = buildGroup(GROUP_CX_LABELS);

  var sorted=cards.slice().sort(function(a,b){
    var aOut=OUT_OF_FLOW_KEYS.has(a.listKey)?1:0; var bOut=OUT_OF_FLOW_KEYS.has(b.listKey)?1:0; if(aOut!==bOut) return aOut-bOut;
    var afo=isFinalOverdue(a)?1:0, bfo=isFinalOverdue(b)?1:0; if(afo!==bfo) return bfo-afo;
    var ao=isOverdue(a)?1:0, bo=isOverdue(b)?1:0; if(ao!==bo) return bo-ao;
    var ap=(a.progress==null? -1:a.progress); var bp=(b.progress==null? -1:b.progress); return bp-ap;
  });

  var overdueFinalCount=cards.filter(function(c){ return isFinalOverdue(c); }).length;
  var overdueStageCount=cards.filter(function(c){ return isOverdue(c); }).length;
  var members=Array.from(cards.reduce(function(m,c){ var k=c.owner||'—'; m.set(k,(m.get(k)||0)+1); return m; }, new Map()).entries()).map(function(e){return {name:e[0],count:e[1]};}).sort(function(a,b){return a.name.localeCompare(b.name);} );

  return { totalValid:totalValid, rawTotal: rawOpen, activeCount:activeCount, doneCount:doneCount,
    overdueFinalCount:overdueFinalCount, overdueStageCount:overdueStageCount,
    byList:byList, byOut:byOut, byPre:byPre, byExec:byExec, byCx:byCx,
    members:members, sorted:sorted };
}

function renderKpis(m){
  var wrap=$('#kpis');
  if(wrap){
    wrap.innerHTML =
      '<div class="card"><div class="row"><span class="tag">Cards Total</span></div><div class="kpi"><span class="big" id="kpi-total">–</span><span class="muted" id="kpi-total-pct">–</span></div></div>'+
      '<div class="card"><div class="row"><span class="tag">Cards Ativos</span></div><div class="kpi"><span class="big" id="kpi-valid">–</span><span class="muted" id="kpi-valid-pct">–</span></div></div>'+
      '<div class="card"><div class="row"><span class="tag danger">Atrasados (final)</span></div><div class="kpi"><span class="big" id="kpi-overdue-final">–</span><span class="muted" id="kpi-overdue-final-pct">–</span></div></div>'+
      '<div class="card"><div class="row"><span class="tag danger">Atrasados (Kaban)</span></div><div class="kpi"><span class="big" id="kpi-overdue">–</span><span class="muted" id="kpi-overdue-pct">–</span></div></div>'+
      '<div class="card"><div class="row"><span class="tag ok">Finalizados</span></div><div class="kpi"><span class="big" id="kpi-done">–</span><span class="muted" id="kpi-done-pct">–</span></div></div>';
  }
  // Cards Total (válidos / bruto)
  var kt=$('#kpi-total'); if(kt) kt.textContent=m.totalValid; var ktp=$('#kpi-total-pct'); if(ktp) ktp.textContent=(m && m.rawTotal)? fmtPct(m.totalValid / m.rawTotal) : '—';
  // Cards Ativos (ativos / válidos)
  var kv=$('#kpi-valid'); if(kv) kv.textContent=m.activeCount; var kvp=$('#kpi-valid-pct'); if(kvp) kvp.textContent=m.totalValid? fmtPct(m.activeCount/m.totalValid):'—';
  // Atrasados (Kaban)
  var ko=$('#kpi-overdue'); if(ko) ko.textContent=m.overdueStageCount; var kop=$('#kpi-overdue-pct'); if(kop) kop.textContent=m.totalValid? fmtPct(m.overdueStageCount/m.totalValid):'—';
  // Atrasados (final)
  var kf=$('#kpi-overdue-final'); if(kf) kf.textContent=m.overdueFinalCount; var kfp=$('#kpi-overdue-final-pct'); if(kfp) kfp.textContent=m.totalValid? fmtPct(m.overdueFinalCount/m.totalValid):'—';
  // Finalizados
  var kd=$('#kpi-done'); if(kd) kd.textContent=m.doneCount; var kdp=$('#kpi-done-pct'); if(kdp) kdp.textContent=m.totalValid? fmtPct(m.doneCount/m.totalValid):'—';
}

function renderKanbanGroup(containerId, labels, map){
  var wrap=document.getElementById(containerId); if(!wrap) return; wrap.innerHTML='';
  var total=0; labels.forEach(function(s){ total += (map.get(norm(s))||0); });
  labels.forEach(function(label){
    var key=norm(label); var qty=map.get(key)||0; var pct= total? (qty/total):0;
    var el=document.createElement('div'); el.className='tile'; el.setAttribute('role','listitem');
    el.innerHTML='<div class="name">'+label+'</div><div class="bar"><div class="fill" style="width:'+Math.round(pct*100)+'%"></div></div><div class="foot"><span>'+qty+' cards</span><span>'+fmtPct(pct)+'</span></div>';
    wrap.appendChild(el);
  });
}

function renderMembers(members){ var wrap=$('#members'); if(!wrap){return;} wrap.innerHTML=''; if(!members.length){ wrap.innerHTML='<div class="muted">Sem responsáveis informados.</div>'; return;} var universe=members.reduce(function(s,m){return s+m.count;},0); members.forEach(function(m){ var pct=universe? (m.count/universe):0; var cap=CONFIG.capacity? CONFIG.capacity[m.name] : undefined; var over=(typeof cap==='number') && (m.count>cap); var badge=''; var el=document.createElement('div'); el.innerHTML='<div class="row" style="justify-content:space-between"><div>'+m.name+' '+badge+'</div><div class="muted '+(over?'overcap':'')+'">'+m.count+(typeof cap==='number'? (' / cap '+cap):'')+' • '+fmtPct(pct)+'</div></div><div class="bar-outer" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="'+Math.round(pct*100)+'" aria-label="'+m.name+'"><div class="bar-inner" style="width:'+Math.round(pct*100)+'%"></div></div>'; wrap.appendChild(el); }); }

var CURRENT_ROWS=[]; var FULL_ROWS=[]; var sortAsc=false;
function renderProjects(rows){
  CURRENT_ROWS=rows.slice();
  var tbody=$('#projects tbody'); if(!tbody) return;
  tbody.innerHTML='';
  rows.forEach(function(c){
    var overdueFinal=isFinalOverdue(c);
    var overdueStage=isOverdue(c);
    var statusTag = OUT_OF_FLOW_KEYS.has(c.listKey)? '<span class="tag warn">Fora do fluxo</span>' :
                    (DONE_LIST_KEYS.has(c.listKey)? '<span class="tag ok">Finalizado</span>' :
                      (overdueFinal? '<span class="tag danger">Atrasado (final)</span>' : (overdueStage? '<span class="tag danger">Atrasado</span>' : '<span class="tag">Andamento</span>')));
    var prog=(c.progress==null)? '—' : fmtPct(c.progress);
    var linkCell = c.url ? ('<a href="'+c.url+'" target="_blank" rel="noopener noreferrer">Abrir</a>') : '—';
    var dueHTML = (overdueStage? '<span class="date overdue">'+fmtDate(c.due)+'</span>' : fmtDate(c.due));
    var finalDueHTML = (overdueFinal? '<span class="date overdue">'+fmtDate(c.finalDue)+'</span>' : fmtDate(c.finalDue));
    var updatedHTML = (function(){
      try{
        var d=c.updatedAt? new Date(c.updatedAt):null;
        var t=new Date(); t.setHours(0,0,0,0);
        var stale = (d && Math.floor((t-d)/(1000*60*60*24))>=STALE_DAYS && !DONE_LIST_KEYS.has(c.listKey) && !OUT_OF_FLOW_KEYS.has(c.listKey));
        return stale? '<span class="date stale">'+fmtDate(c.updatedAt)+'</span>' : fmtDate(c.updatedAt);
      }catch(_){ return fmtDate(c.updatedAt); }
    })();
    var tr=document.createElement('tr');
    tr.innerHTML=
      '<td><div style="font-weight:700">'+(c.name||'—')+'</div><div class="muted">'+statusTag+'</div></td>'+
      '<td>'+(c.list||'—')+'</td>'+
      '<td>'+(c.owner||'—')+'</td>'+
      '<td>'+ dueHTML +'</td>'+
      '<td>'+ finalDueHTML +'</td>'+
      '<td>'+ tagForPUC(c.puc) +'</td>'+
      '<td class="right" style="font-weight:700">'+ prog +'</td>'+
      '<td>'+ updatedHTML +'</td>'+
      '<td>'+ linkCell +'</td>';
    tbody.appendChild(tr);
  });
  var trEl=$('#totalRows'); if(trEl) trEl.textContent=rows.length;
}

function applyTableFilters(){ var rows=FULL_ROWS.slice(); renderProjects(rows); }

// ===== Orquestração =====
var LAST_RAW=null;
function loadAndRender(raw){
  try{
    var ing=ingestTrello(raw); LAST_RAW=raw;
    var metrics=compute(ing.cards, ing.rawOpenCount);
    renderKpis(metrics);
    renderKanbanGroup('kanban-out', ['Backlog','Suspenso','Cancelado'], metrics.byOut);
    renderKanbanGroup('kanban-pre', ['Nova Demanda','Estudo Téc/RN','Levantamento de Esforço','Aprovação de Esforço'], metrics.byPre);
    renderKanbanGroup('kanban-exec', ['Planejamento','Cronograma','Debito Técnico','Construção da EF','Confirmação da EF (WTéc)','Validação EF','Pronto para DEV','Dev','QA Wittel','Certificação','Deploy'], metrics.byExec);
    renderKanbanGroup('kanban-cx',  ['Acompanha Resultados'], metrics.byCx);
    renderMembers(metrics.members);
    FULL_ROWS=metrics.sorted; applyTableFilters();
    setMsg('Arquivo carregado com sucesso • '+metrics.activeCount+' cards ativos');
    $('#mainContent').scrollIntoView({behavior:'smooth', block:'start'});
  }catch(e){ console.error(e); setMsg('Erro ao processar: '+(e.message||e)); alert('Não consegui ler este JSON.\n\n'+(e.message||e)); }
}

// ===== UI Handlers =====
(function(){ var _hdr=$('#projects thead th[data-sort="progress"]'); if(!_hdr){ logd('SORT: cabeçalho não encontrado (progress)'); return; } _hdr.addEventListener('click', function(){ sortAsc=!sortAsc; var sorted=CURRENT_ROWS.slice().sort(function(a,b){ var ap=(a.progress==null? -1:a.progress); var bp=(b.progress==null? -1:b.progress); return sortAsc? (ap-bp):(bp-ap); }); renderProjects(sorted); }); })();

var fileInput=$('#fileInput'); var fileLabel=$('#fileLabel');
fileInput.addEventListener('change', function(ev){ var f=ev.target.files && ev.target.files[0]; if(!f){return;}  try{ setMsg('Lendo arquivo: '+f.name+'…'); var reader=new FileReader(); reader.onload=function(){ try{ var txt=String(reader.result||''); var clean=txt.replace(/^\uFEFF/, ''); clean = clean.replace(/^\ufeff/, ''); var json=JSON.parse(clean); loadAndRender(json);}catch(e){ console.error(e); setMsg('Erro ao ler arquivo: '+(e.message||e)); alert('Arquivo inválido.\n\n'+(e.message||e)); } }; reader.onerror=function(){ setMsg('Falha ao ler arquivo: '+(reader.error||''));}; reader.readAsText(f); }catch(e){ setMsg('Erro ao preparar leitura: '+(e.message||e)); } });

// Erros globais
window.addEventListener('error', function(e){ setMsg('Erro de script: '+(e && e.message? e.message : 'desconhecido')); });
window.addEventListener('unhandledrejection', function(e){ var m=(e && e.reason && (e.reason.message||e.reason))||'desconhecido'; setMsg('Erro assíncrono: '+m); });

// Self-tests mínimos
(function selfTests(){ try{ if(!document.getElementById('kpis')) logd('TEST FAIL: #kpis inexistente'); else logd('TEST OK: #kpis'); if(!document.getElementById('members')) logd('TEST FAIL: #members inexistente'); else logd('TEST OK: #members'); renderKpis({activeCount:0,totalValid:0,doneCount:0,overdueStageCount:0,overdueFinalCount:0, rawTotal:0}); logd('TEST OK: renderKpis executou'); var mini={lists:[{id:'L1',name:'Dev'}], members:[{id:'M1',fullName:'Teste User'}], checklists:[], cards:[{id:'C1',idList:'L1',name:'Card X',closed:false,idMembers:['M1'],labels:[],dateLastActivity:'2025-08-01T00:00:00Z'}]}; var ing=ingestTrello(mini); if(!ing || !Array.isArray(ing.cards) || ing.cards.length!==1){ logd('TEST FAIL: ingestTrello mini'); } else { logd('TEST OK: ingestTrello mini'); } }catch(err){ logd('TEST FAIL:', err.message||err); }})();
</script>
</body>
</html>
