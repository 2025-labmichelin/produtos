<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard – Neoenergia × Wittel</title>
  <style>
    :root{
      /* Light theme */
      --bg:#F7F9FC;           /* página */
      --card:#FFFFFF;         /* cards/tabelas */
      --surface-2:#F1F5F9;    /* superfícies internas */
      --stroke:#E5E7EB;       /* bordas */
      --text:#0F172A;         /* texto principal */
      --muted:#475569;        /* texto secundário */

      /* Semânticas (Neoenergia) */
      --ok:#00A443;           /* Concluído */
      --warn:#F68C1B;         /* Fora do fluxo / Urgente */
      --danger:#EF4444;       /* Atrasos / Crítico */
      --primary:#2CB6FF;      /* Prioridade / CTAs */

      /* Legados/auxiliares */
      --accent:#2CB6FF;       /* gradientes leves */
      --accent-2:#2CB6FF;     /* botão principal */
      --chip:#F1F5F9;
      --focus:#7C3AED;        /* foco acessível */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; line-height:1.5}
    :focus-visible{outline:2px solid var(--focus); outline-offset:3px; border-radius:8px}

    header{padding:20px; border-bottom:1px solid var(--stroke); display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; background:var(--card)}
    .brand{display:flex; align-items:center; gap:10px}
    .brand h1{font-size:18px; margin:0}
    .actions{display:flex; gap:8px; flex-wrap:wrap}

    .btn{background:var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer}
    .btn.secondary{background:var(--card); color:var(--text); border:1px solid var(--stroke)}

    .file-wrap{position:relative}
    input[type=file]{position:absolute; inset:0; opacity:0; cursor:pointer}
    .file-label{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; background:var(--primary); color:#fff; border:none; font-weight:700; cursor:pointer}

    main{padding:22px; max-width:1400px; margin:0 auto}
    .grid{display:grid; gap:16px}
    .cols-2{grid-template-columns:repeat(2, minmax(0,1fr))}
    @media (max-width:900px){.cols-2{grid-template-columns:1fr}}

    .card{background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:16px}
    .card h2{margin:0 0 10px; font-size:16px; font-weight:700}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .kpi{display:flex; align-items:baseline; justify-content:space-between; border-top:1px dashed var(--stroke); padding-top:10px; margin-top:10px}
    .kpi .big{font-size:28px; font-weight:800}

    .kanban-list{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:10px}
    @media (max-width:1100px){.kanban-list{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:680px){.kanban-list{grid-template-columns:1fr}}
    .tile{background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:12px}
    .tile .name{font-weight:700; margin:0 0 6px}
    .tile .bar{height:8px; background:#1c2330; border-radius:999px; overflow:hidden}
    .tile .fill{height:8px; background:linear-gradient(90deg, var(--accent-2), #8b5cf6)}
    .tile .foot{display:flex; justify-content:space-between; margin-top:6px; color:var(--muted); font-size:12px}

    .bars{display:flex; flex-direction:column; gap:10px; margin-top:6px}
    .bar-outer{height:12px; background:var(--surface-2); border:1px solid var(--stroke); border-radius:999px; overflow:hidden}
    .bar-inner{height:12px; background:linear-gradient(90deg, var(--primary), #7C3AED)}

    table{width:100%; border-collapse:collapse; margin-top:8px; font-size:14px}
    th, td{padding:10px 8px; border-bottom:1px solid var(--stroke); vertical-align:top}
    th{color:var(--muted); font-weight:600; text-align:left}
    tr:last-child td{border-bottom:none}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px; font-size:12px; background:var(--surface-2); border:1px solid var(--stroke); color:var(--muted)}
    .tag.ok{background:rgba(0,164,67,.12); color:var(--ok); border-color:rgba(0,164,67,.3)}
    .tag.warn{background:rgba(246,140,27,.15); color:var(--warn); border-color:rgba(246,140,27,.35)}
    .tag.danger{background:rgba(239,68,68,.15); color:var(--danger); border-color:rgba(239,68,68,.35)}
    .tag.info{background:rgba(44,182,255,.12); color:var(--primary); border-color:rgba(44,182,255,.3)}
    .hidden{display:none}

    .badge{display:inline-flex; align-items:center; gap:6px; padding:2px 6px; border-radius:999px; font-size:11px; background:#0f1722; border:1px solid var(--stroke); color:var(--muted)}
    .badge.new{background:rgba(96,165,250,.12); color:#93c5fd; border-color:rgba(96,165,250,.3)}
    .overcap{color:#fca5a5}
  .status-pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; background:var(--surface-2); border:1px solid var(--stroke); color:var(--muted)}
  .date.overdue{color:var(--danger);font-weight:700}
#projects.table-sticky thead th{position:sticky;top:0;background:var(--card);z-index:2;box-shadow:0 2px 0 0 var(--stroke)}
#projects tbody tr:nth-child(odd){background:rgba(0,0,0,.02)}
#projects tbody tr:hover{background:rgba(0,0,0,.04)}
  .hero{position:relative; border-radius:16px; padding:24px; color:#fff; background:linear-gradient(90deg,#0B5FA8 0%, #1DA1A9 55%, #33C17C 100%);} 
.hero::before{content:""; position:absolute; inset:0; border-radius:inherit; background:linear-gradient(0deg, rgba(0,0,0,.16), rgba(0,0,0,.16));}
.hero .content{position:relative; display:flex; gap:16px; align-items:flex-start; justify-content:space-between}
.hero h2{margin:0 0 6px; font-size:20px; font-weight:800; letter-spacing:-.2px}
.hero p{margin:0; font-size:14px; opacity:.95; max-width:56ch}
.kpi-hero{display:flex; gap:24px; align-items:center}
.kpi-hero .num{font-size:32px; font-weight:800; line-height:1}
.kpi-hero .label{font-size:12px; opacity:.92; letter-spacing:.2px}
</style>
</head>
<body>
  <header>
    <div class="brand"></div>
    <div class="actions" role="group" aria-label="Carregar dados">
      <div class="file-wrap">
        <span id="fileLabel" class="file-label" aria-live="polite">Carregar JSON</span>
        <input id="fileInput" type="file" accept=".json,application/json" aria-describedby="fileHelp">
      </div>
      <span id="hdrStatus" class="status-pill">Pronto</span>
    </div>
  </header>

  <div id="msg" style="padding:10px 20px;color:var(--muted);background:var(--surface-2);border-bottom:1px solid var(--stroke);font-size:12px">Pronto para carregar um JSON do Trello…</div>
  <details id="dbg" style="margin:8px 22px"><summary style="cursor:pointer">Diagnóstico</summary>
    <pre id="dbgLog" style="white-space:pre-wrap; font-size:12px; color:var(--muted); background:#0e1116; border:1px solid var(--stroke); border-radius:10px; padding:10px; max-height:200px; overflow:auto"></pre>
  </details>

  <main id="mainContent" class="grid cols-2">
    <section id="heroBanner" class="hero" style="grid-column:1 / -1">
      <div class="content">
        <div>
          <h2>Visão Geral dos Projetos</h2>
          <p>Acompanhe o progresso, identifique gargalos e otimize o desempenho da equipe</p>
        </div>
      </div>
    </section>
    <section class="card" aria-labelledby="resumo-h2">
      <h2 id="resumo-h2">Resumo</h2>
      <div id="kpis" class="grid cols-2">
        <div class="card"><div class="row"><span class="tag">Cards válidos</span></div><div class="kpi"><span class="big" id="kpi-valid">–</span><span class="muted" id="kpi-valid-pct">–</span></div></div>
        <div class="card"><div class="row"><span class="tag">Finalizados</span></div><div class="kpi"><span class="big" id="kpi-done">–</span><span class="muted" id="kpi-done-pct">–</span></div></div>
      </div>
      <p id="fileHelp" class="muted" style="margin-top:8px">
  Regras: exclui lista Painel e cards cujo name = nome da lista.<br>
  Fora do fluxo: Backlog, Suspenso, Cancelado.<br>
  Finalizados: Concluído, Acompanha Resultados.
</p>
    </section>

    <section class="card" aria-labelledby="membros-h2">
      <h2 id="membros-h2">Membros</h2>
      
      <div id="members" class="bars"></div>
    </section>

    <section class="card" style="grid-column:1 / -1" aria-labelledby="kanban-h2">
      <div class="row"><h2 id="kanban-h2" style="margin-right:auto">Kanban</h2><span class="tag">Somente listas ativas</span></div>
      <div id="kanban" class="kanban-list" role="list"></div>
    </section>

    <section class="card" style="grid-column:1 / -1" aria-labelledby="projetos-h2">
      <div class="row"><h2 id="projetos-h2">Projetos (Progresso %)</h2></div>
      <div class="row" style="justify-content:flex-end; align-items:center">
        <div class="muted">Total: <span id="totalRows">0</span></div>
      </div>
      <table id="projects" class="table-sticky">
        <thead>
          <tr>
            <th data-sort="name">Projeto</th>
            <th data-sort="list">Lista</th>
            <th data-sort="owner">Responsável</th>
            <th data-sort="due">Entrega</th>
            <th data-sort="finalDue">Entrega Final</th>
            <th data-sort="puc">PUC</th>
            <th class="right" data-sort="progress" style="cursor:pointer" title="Ordenar">Progresso ▲▼</th>
            <th data-sort="url">Card</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer style="padding:18px 22px; border-top:1px solid var(--stroke); color:var(--muted); display:flex; justify-content:space-between; flex-wrap:wrap; gap:12px">
    <span>Dashboard local – seus dados não saem do navegador.</span>
    <span>Carregue um export JSON do Trello.</span>
  </footer>

<script>
"use strict";
// ===== Helpers =====
function $(sel,root){return (root||document).querySelector(sel);} 
function $$(sel,root){return Array.from((root||document).querySelectorAll(sel));}
function logd(){var s=Array.from(arguments).map(function(x){try{return typeof x==='string'?x:JSON.stringify(x);}catch(_){return String(x);}}).join(' '); var el=$('#dbgLog'); if(el){el.textContent+=s+'\n'; el.scrollTop=el.scrollHeight;} if(window.console&&console.debug){console.debug('[DBG]',s);} }
function setMsg(t){
  var el = $('#msg'); if(el){ el.textContent = t; }
  var hs = $('#hdrStatus'); if(hs){ hs.textContent = t; }
}

function stripAccents(s){return s? s.normalize('NFD').replace(/[\u0300-\u036f]/g,''):'';}
function norm(s){s=String(s||'').trim(); s=s.replace(/\s+/g,' '); var k=stripAccents(s).toLowerCase(); if(k==='acompanha resultado'||k==='acompanha resultados') return 'acompanha resultados'; if(k==='concluido'||k==='concluído') return 'concluido'; if(k==='painel') return 'painel'; if(k==='backlog') return 'backlog'; if(k==='suspenso') return 'suspenso'; if(k==='cancelado') return 'cancelado'; return k;}
function renderLabel(key){if(key==='acompanha resultados') return 'Acompanha Resultados'; if(key==='concluido') return 'Concluído'; if(key==='painel') return 'Painel'; if(key==='backlog') return 'Backlog'; if(key==='suspenso') return 'Suspenso'; if(key==='cancelado') return 'Cancelado'; return key.split(' ').map(function(w){var lows={de:1,da:1,do:1,dos:1,das:1,e:1,ou:1,em:1,no:1,na:1}; return lows[w]?w:(w.charAt(0).toUpperCase()+w.slice(1));}).join(' ');} 
function titleCaseLike(str){if(!str) return ''; var low=['de','da','do','dos','das','e','ou','em','no','na']; return String(str).split(' ').map(function(w){if(!w) return w; return low.indexOf(w.toLowerCase())>-1 ? w.toLowerCase() : (w.charAt(0).toUpperCase()+w.slice(1));}).join(' ');} 
function normalizeMember(raw){if(!raw) return '—'; var key=String(raw).trim(); return MEMBER_MAP.get(key)||titleCaseLike(key);} 
function fmtPct(n){if(isNaN(n)||n==null) return '—'; var v=Math.round(n*1000)/10; return (v.toFixed(1).replace('.0',''))+'%';}
function fmtDate(s){if(!s) return '—'; var d=new Date(s); if(isNaN(d)) return '—'; var dd=String(d.getDate()).padStart(2,'0'); var mm=String(d.getMonth()+1).padStart(2,'0'); var yyyy=d.getFullYear(); return dd+'/'+mm+'/'+yyyy;}
function tagForPUC(puc){
  var v=String(puc||'').toLowerCase();
  if(v==='crítico'||v==='critico') return '<span class="tag danger">Crítico</span>';
  if(v==='urgente') return '<span class="tag warn">Urgente</span>';
  if(v==='prioridade') return '<span class="tag info">Prioridade</span>';
  return '<span class="tag">—</span>';
}
// Regra: atrasado = tem due no passado e não está finalizado nem fora do fluxo
function isOverdue(c){ try{ if(!c||!c.due) return false; if(DONE_LIST_KEYS.has(c.listKey)||OUT_OF_FLOW_KEYS.has(c.listKey)) return false; var d=new Date(c.due); if(isNaN(d)) return false; var today=new Date(); today.setHours(0,0,0,0); return d < today; }catch(_){ return false; } }
// Regra: atrasado (final) = possui finalDue no passado e não está finalizado
function isFinalOverdue(c){
  try{
    if(!c || !c.finalDue) return false;
    if (DONE_LIST_KEYS.has(c.listKey) || OUT_OF_FLOW_KEYS.has(c.listKey)) return false;
    var d = new Date(c.finalDue);
    if (isNaN(d)) return false;
    var today = new Date();
    today.setHours(0,0,0,0);
    return d < today;
  }catch(_){ return false; }
}

// ===== Config =====
var ORDERED_ACTIVE_LABELS=[
  'A fazer','Estudo Téc/RN','Levantamento de esforço','Aprovação de esforço','Construção Crono',
  'Construção da EF','Validação da EF','Débito Técnico','Dev','Homologação','Certificação','Deploy',
  'Acompanha Resultados','Concluído'
];
var ORDERED_ACTIVE_KEYS=ORDERED_ACTIVE_LABELS.map(norm);
var OUT_OF_FLOW_KEYS=new Set(['Backlog','Suspenso','Cancelado'].map(norm));
var DONE_LIST_KEYS=new Set(['Concluído','Acompanha Resultados'].map(norm));
var EXCLUDE_FULL_LIST_KEYS=new Set(['Painel'].map(norm));
var MEMBER_MAP=new Map([
  ['Beatriz Cristina Causs Barbieri','Beatriz Causs'],
  ['ricardo.michelin','Ricardo Michelin'],
  ['Renan mora rodrigues da silva','Renan Mora'],
  ['Nataly Rubi Cardoso','Nataly Cardoso'],
  ['mariany.felix','Mariany Felix'],
  ['patricia.tasseli','Patricia Tasseli']
]);

// members.json (opcional; não bloqueia nada)
var CONFIG={aliases:{},teams:{},capacity:{}};
(function(){ try{ if(/^https?:/i.test(location.protocol)){ fetch('./members.json?nocache='+(Date.now()),{cache:'no-cache'}).then(function(r){ if(!r.ok) return null; return r.json(); }).then(function(j){ if(!j) return; CONFIG.aliases=j.aliases||{}; CONFIG.teams=j.teams||{}; CONFIG.capacity=j.capacity||{}; Object.keys(CONFIG.aliases).forEach(function(alias){ MEMBER_MAP.set(alias, CONFIG.aliases[alias]); }); setMsg('Config de membros carregada'); }).catch(function(){/* ignora */}); } }catch(_){/* ignora */} })();

// Util: extrai primeira data válida de um texto (DD/MM/AAAA ou AAAA-MM-DD)
function parseDateFromText(text){
  try{
    if(!text) return null; var s=String(text).trim();
    var parts = s.split(' ');
    for(var i=0;i<parts.length;i++){
      var t = parts[i]; if(!t) continue;
      if(t.indexOf('/')>-1){ var a=t.split('/'); if(a.length===3){ var d=parseInt(a[0],10), mo=parseInt(a[1],10)-1, y=parseInt(a[2],10); var dt=new Date(y,mo,d); if(!isNaN(dt)) return dt; } }
      if(t.indexOf('-')>-1){ var b=t.split('-'); if(b.length===3){ var y2=parseInt(b[0],10), mo2=parseInt(b[1],10)-1, d2=parseInt(b[2],10); var dt2=new Date(y2,mo2,d2); if(!isNaN(dt2)) return dt2; } }
    }
    return null;
  }catch(_){ return null; }
}

// ===== Parse Trello JSON =====
function ingestTrello(raw){
  var listsById=new Map();
  var membersById=new Map();
  var checklistsByCard=new Map();
  var finalDueByCard=new Map();
  var cards=[];

  if(Array.isArray(raw.cards)&&Array.isArray(raw.lists)){
    raw.lists.forEach(function(l){ listsById.set(l.id,{id:l.id,name:String(l.name||'').trim(),closed:!!l.closed}); });
    if(Array.isArray(raw.members)) raw.members.forEach(function(m){ var name=m.fullName||m.username||m.name||''; membersById.set(m.id, normalizeMember(name)); });
    if(Array.isArray(raw.checklists)) raw.checklists.forEach(function(cl){
      var items=Array.isArray(cl.checkItems)?cl.checkItems:[];
      // progresso agregado por card
      var done=items.filter(function(i){return String(i.state).toLowerCase()==='complete';}).length;
      var total=items.length; var cur=checklistsByCard.get(cl.idCard)||{done:0,total:0};
      checklistsByCard.set(cl.idCard,{done:cur.done+done,total:cur.total+total});
      // extrair "Data de Entrega" (usa a MAIOR data válida entre os itens)
      var clKey=norm(cl.name||'');
      if(clKey.indexOf('data de entrega')>-1){
        var best=null;
        items.forEach(function(it){ var d=parseDateFromText(it && it.name); if(d){ if(!best || d>best) best=d; } });
        if(best) finalDueByCard.set(cl.idCard, best.toISOString());
      }
    });
    cards=(raw.cards||[]).filter(function(c){return !c.closed;}).map(function(c){
      var list=listsById.get(c.idList); var listName=list?list.name:(c.listName||''); var listKey=norm(listName);
      var puc=null; if(Array.isArray(c.labels)){ var names=c.labels.map(function(l){return (l.name||'').toLowerCase();}); if(names.indexOf('crítico')>-1||names.indexOf('critico')>-1) puc='Crítico'; else if(names.indexOf('urgente')>-1) puc='Urgente'; else if(names.indexOf('prioridade')>-1) puc='Prioridade'; } else if(typeof c.puc==='string'){ puc=c.puc; }
      var owner='—'; if(Array.isArray(c.idMembers)&&c.idMembers.length){ var m=membersById.get(c.idMembers[0]); if(m) owner=m; } else if(c.member){ owner=normalizeMember(c.member);} 
      var agg=checklistsByCard.get(c.id)||{done:0,total:0}; var progress=agg.total>0? (agg.done/agg.total):null;
      var finalDue=finalDueByCard.get(c.id)||null;
      var url=c.url || (c.shortLink? ('https://trello.com/c/'+c.shortLink): null);
      return { id:c.id, name:String(c.name||'').trim(), list:listName, listKey:listKey, due:c.due||c.dueDate||c.dataEntrega||null, finalDue:finalDue, owner:owner, puc:puc, progress:progress, url:url };
    });
  } else if(Array.isArray(raw)){
    cards=raw.map(function(c){ var listName=(c.list||c.lista||'').trim(); return { id:c.id||c.cardId||Math.random().toString(36).slice(2), name:(c.name||c.card||'').trim(), list:listName, listKey:norm(listName), due:c.due||c.dueDate||c.dataEntrega||null, finalDue:c.finalDue||null, owner:normalizeMember(c.owner||c.responsavel||c.member||''), puc:c.puc||c.PUC||null, progress:(typeof c.progressPct==='number')?(c.progressPct/100): (typeof c.progress==='number')?c.progress:null, url:c.url||null }; });
  } else { throw new Error('Formato de JSON não reconhecido.'); }

  // filtros
  cards=cards.filter(function(c){return !EXCLUDE_FULL_LIST_KEYS.has(c.listKey);});
  cards=cards.filter(function(c){return (c.name||'')!==(c.list||'');});
  return {cards:cards};
}

// ===== Métricas & Render =====
function compute(cards){
  var totalValid=cards.length;
  var doneCount=cards.filter(function(c){return DONE_LIST_KEYS.has(c.listKey);}).length;
  var byList=new Map(ORDERED_ACTIVE_KEYS.map(function(k){return [k,0];}));
  cards.forEach(function(c){ if(byList.has(c.listKey)){ byList.set(c.listKey,(byList.get(c.listKey)||0)+1); } });
  var byMember=new Map();
  cards.forEach(function(c){ var m=c.owner||'—'; byMember.set(m,(byMember.get(m)||0)+1); });
  var members=Array.from(byMember.entries()).map(function(e){return {name:e[0],count:e[1]};}).sort(function(a,b){return a.name.localeCompare(b.name);});
  var sorted=cards.slice().sort(function(a,b){
    var aOut=OUT_OF_FLOW_KEYS.has(a.listKey)?1:0; var bOut=OUT_OF_FLOW_KEYS.has(b.listKey)?1:0;
    if(aOut!==bOut) return aOut-bOut; // em fluxo primeiro
    var afo=isFinalOverdue(a)?1:0, bfo=isFinalOverdue(b)?1:0; if(afo!==bfo) return bfo-afo; // final atrasado primeiro
    var ao=isOverdue(a)?1:0, bo=isOverdue(b)?1:0; if(ao!==bo) return bo-ao; // depois atrasados de etapa
    var ap=(a.progress==null? -1:a.progress); var bp=(b.progress==null? -1:b.progress); return bp-ap;
  });
  var overdueFinalCount=cards.filter(function(c){ return isFinalOverdue(c); }).length;
  var overdueStageCount=cards.filter(function(c){ return isOverdue(c); }).length;
  return { totalValid:totalValid, doneCount:doneCount, overdueFinalCount:overdueFinalCount, overdueStageCount:overdueStageCount, byList:byList, members:members, sorted:sorted };
}
function renderKpis(m){
  var wrap=$('#kpis');
  if(wrap){
    wrap.innerHTML =
      '<div class="card"><div class="row"><span class="tag danger">Atrasados (final)</span></div><div class="kpi"><span class="big" id="kpi-overdue-final">–</span><span class="muted" id="kpi-overdue-final-pct">–</span></div></div>'+
      '<div class="card"><div class="row"><span class="tag danger">Atrasados (Kaban)</span></div><div class="kpi"><span class="big" id="kpi-overdue">–</span><span class="muted" id="kpi-overdue-pct">–</span></div></div>'+
      '<div class="card"><div class="row"><span class="tag ok">Finalizados</span></div><div class="kpi"><span class="big" id="kpi-done">–</span><span class="muted" id="kpi-done-pct">–</span></div></div>'+
      '<div class="card"><div class="row"><span class="tag">Cards válidos</span></div><div class="kpi"><span class="big" id="kpi-valid">–</span><span class="muted" id="kpi-valid-pct">–</span></div></div>';
  }
  $('#kpi-valid').textContent=m.totalValid; $('#kpi-valid-pct').textContent=m.totalValid? fmtPct(1):'—';
  $('#kpi-done').textContent=m.doneCount; $('#kpi-done-pct').textContent=m.totalValid? fmtPct(m.doneCount/m.totalValid):'—';
  $('#kpi-overdue').textContent=m.overdueStageCount; $('#kpi-overdue-pct').textContent=m.totalValid? fmtPct(m.overdueStageCount/m.totalValid):'—';
  $('#kpi-overdue-final').textContent=m.overdueFinalCount; $('#kpi-overdue-final-pct').textContent=m.totalValid? fmtPct(m.overdueFinalCount/m.totalValid):'—';
}
function renderKanban(byList, total){ var wrap=$('#kanban'); wrap.innerHTML=''; ORDERED_ACTIVE_KEYS.forEach(function(key,idx){ var qty=byList.get(key)||0; var pct=total? (qty/total):0; var label=ORDERED_ACTIVE_LABELS[idx]; var el=document.createElement('div'); el.className='tile'; el.setAttribute('role','listitem'); el.innerHTML='<div class="name">'+label+'</div><div class="bar"><div class="fill" style="width:'+Math.round(pct*100)+'%"></div></div><div class="foot"><span>'+qty+' cards</span><span>'+fmtPct(pct)+'</span></div>'; wrap.appendChild(el); }); }
function renderMembers(members){ var wrap=$('#members'); wrap.innerHTML=''; if(!members.length){ wrap.innerHTML='<div class="muted">Sem responsáveis informados.</div>'; return;} var universe=members.reduce(function(s,m){return s+m.count;},0); members.forEach(function(m){ var pct=universe? (m.count/universe):0; var cap=CONFIG.capacity? CONFIG.capacity[m.name] : undefined; var over=(typeof cap==='number') && (m.count>cap); var badge=''; var el=document.createElement('div'); el.innerHTML='<div class="row" style="justify-content:space-between"><div>'+m.name+' '+badge+'</div><div class="muted '+(over?'overcap':'')+'">'+m.count+(typeof cap==='number'? (' / cap '+cap):'')+' • '+fmtPct(pct)+'</div></div><div class="bar-outer" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="'+Math.round(pct*100)+'" aria-label="'+m.name+'"><div class="bar-inner" style="width:'+Math.round(pct*100)+'%"></div></div>'; wrap.appendChild(el); }); }

var CURRENT_ROWS=[]; var FULL_ROWS=[]; var sortAsc=false;
function renderProjects(rows){
  CURRENT_ROWS=rows.slice(); var tbody=$('#projects tbody'); tbody.innerHTML='';
  rows.forEach(function(c){
    var overdueFinal=isFinalOverdue(c); var overdueStage=isOverdue(c);
    var statusTag = OUT_OF_FLOW_KEYS.has(c.listKey)? '<span class="tag warn">Fora do fluxo</span>' :
                    (DONE_LIST_KEYS.has(c.listKey)? '<span class="tag ok">Finalizado</span>' :
                      (overdueFinal? '<span class="tag danger">Atrasado (final)</span>' : (overdueStage? '<span class="tag danger">Atrasado</span>' : '<span class="tag">Andamento</span>')));
    var prog=(c.progress==null)? '—' : fmtPct(c.progress);
    var linkCell = c.url ? ('<a href="'+c.url+'" target="_blank" rel="noopener noreferrer">Abrir</a>') : '—';
    var tr=document.createElement('tr');
    tr.innerHTML=
      '<td><div style="font-weight:700">'+(c.name||'—')+'</div><div class="muted">'+statusTag+'</div></td>'+
      '<td>'+(c.list||'—')+'</td>'+
      '<td>'+(c.owner||'—')+'</td>'+
      '<td>'+fmtDate(c.due)+'</td>'+
      '<td>'+fmtDate(c.finalDue)+'</td>'+
      '<td>'+tagForPUC(c.puc)+'</td>'+
      '<td class="right" style="font-weight:700">'+prog+'</td>'+
      '<td>'+linkCell+'</td>';
    tbody.appendChild(tr);
  });
  $('#totalRows').textContent=rows.length;
}
function populateMemberFilter(members){ var sel=$('#memberFilter'); if(!sel) return; var current=sel.value; sel.innerHTML='<option value="">Todos</option>'+members.map(function(m){return '<option value="'+m.name+'">'+m.name+'</option>';}).join(''); if(current && Array.from(sel.options).some(function(o){return o.value===current;})) sel.value=current; }
function applyTableFilters(){ var rows=FULL_ROWS.slice(); var q=($('#filterInput')&&$('#filterInput').value||'').trim().toLowerCase(); var who=($('#memberFilter')&&$('#memberFilter').value)||''; if(q){ rows=rows.filter(function(r){return (r.name||'').toLowerCase().indexOf(q)>-1;}); } if(who){ rows=rows.filter(function(r){return (r.owner||'')===who;}); } renderProjects(rows); }

// ===== Orquestração =====
var LAST_RAW=null;
function loadAndRender(raw){ try{ var ing=ingestTrello(raw); LAST_RAW=raw; var metrics=compute(ing.cards); renderKpis(metrics); renderKanban(metrics.byList, metrics.totalValid); renderMembers(metrics.members);
  try{ if(typeof updateHeroWithMetrics==='function'){ updateHeroWithMetrics(metrics); } }catch(_){ } FULL_ROWS=metrics.sorted; populateMemberFilter(metrics.members); applyTableFilters(); setMsg('Arquivo carregado com sucesso • '+metrics.totalValid+' cards válidos'); $('#mainContent').scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){ console.error(e); setMsg('Erro ao processar: '+(e.message||e)); alert('Não consegui ler este JSON.\n\n'+(e.message||e)); } }

// ===== UI Handlers =====
$('#projects thead th[data-sort="progress"]').addEventListener('click', function(){ sortAsc=!sortAsc; var sorted=CURRENT_ROWS.slice().sort(function(a,b){ var ap=(a.progress==null? -1:a.progress); var bp=(b.progress==null? -1:b.progress); return sortAsc? (ap-bp):(bp-ap); }); renderProjects(sorted); });

var fileInput=$('#fileInput'); var fileLabel=$('#fileLabel');
fileInput.addEventListener('change', function(ev){ var f=ev.target.files && ev.target.files[0]; if(!f){return;}  try{ var reader=new FileReader(); reader.onload=function(){ try{ var txt=String(reader.result||''); var clean=txt.replace(/^\uFEFF/, ''); var json=JSON.parse(clean); loadAndRender(json);}catch(e){ console.error(e); setMsg('Erro ao ler arquivo: '+(e.message||e)); alert('Arquivo inválido.\n\n'+(e.message||e)); } }; reader.onerror=function(){ setMsg('Falha ao ler arquivo: '+(reader.error||''));}; reader.readAsText(f); }catch(e){ setMsg('Erro ao preparar leitura: '+(e.message||e)); } });

var _bDemo=$('#btnDemo'); if(_bDemo) _bDemo.addEventListener('click', function(){ var demo={ lists:[{id:'l1',name:'Dev'},{id:'l2',name:'Concluído'},{id:'l3',name:'Backlog'},{id:'l4',name:'Acompanha Resultados'}], members:[{id:'m1',fullName:'ricardo.michelin'},{id:'m2',fullName:'Beatriz Cristina Causs Barbieri'}], checklists:[{idCard:'c1',checkItems:[{state:'complete'},{state:'complete'},{state:'incomplete'}]},{idCard:'c2',checkItems:[{state:'complete'},{state:'complete'}]}], cards:[ {id:'c1',idList:'l1',name:'Integração API X',due:'2025-09-20',idMembers:['m1'],labels:[{name:'Urgente'}]}, {id:'c2',idList:'l2',name:'Entrega Módulo Y',due:'2025-08-30',idMembers:['m2'],labels:[{name:'Prioridade'}]}, {id:'c3',idList:'l3',name:'Backlog',due:null,idMembers:['m2'],labels:[]}, {id:'c4',idList:'l4',name:'Estudo Z',due:null,idMembers:[],labels:[{name:'Crítico'}]} ] }; loadAndRender(demo); setMsg('Demo carregada • '+demo.cards.length+' cards'); });

var _bReset=$('#btnReset'); if(_bReset) _bReset.addEventListener('click', function(){ LAST_RAW=null; $('#kpi-valid').textContent='–'; $('#kpi-valid-pct').textContent='–'; $('#kpi-done').textContent='–'; $('#kpi-done-pct').textContent='–'; $('#members').innerHTML=''; $('#kanban').innerHTML=''; $('#projects tbody').innerHTML=''; $('#totalRows').textContent='0'; fileInput.value=''; fileLabel.textContent='Selecionar JSON do Trello'; setMsg('Pronto para carregar um JSON do Trello…'); });

var _bFetch=$('#btnFetchLocal'); if(_bFetch) _bFetch.addEventListener('click', function(){ (function(){ try{ if(location.protocol==='file:'){ setMsg('Aviso: aberto via file://. Alguns navegadores bloqueiam leitura local. Prefira http (ex.: GitHub Pages) ou use Selecionar JSON.'); } fetch('./projetos.json?nocache='+(Date.now()),{cache:'no-cache'}).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(function(j){ loadAndRender(j); setMsg('Arquivo carregado: ./projetos.json'); }).catch(function(e){ console.error(e); setMsg('Falha ao carregar ./projetos.json: '+(e.message||e)); alert('Não foi possível ler ./projetos.json.'); }); }catch(e){ setMsg('Falha geral ao buscar ./projetos.json: '+(e.message||e)); } })(); });

// Erros globais
window.addEventListener('error', function(e){ setMsg('Erro de script: '+(e && e.message? e.message : 'desconhecido')); });
window.addEventListener('unhandledrejection', function(e){ var m=(e && e.reason && (e.reason.message||e.reason))||'desconhecido'; setMsg('Erro assíncrono: '+m); });
function updateHeroWithMetrics(m){ try{ var listsCount=0; if(m && m.byList){ m.byList.forEach(function(v){ if(v>0) listsCount++; }); } var hc=document.getElementById('hero-cards'); if(hc) hc.textContent = (m && typeof m.totalValid==='number')? m.totalValid : '–'; var hm=document.getElementById('hero-members'); if(hm) hm.textContent = (m && m.members)? m.members.length : '–'; var hl=document.getElementById('hero-lists'); if(hl) hl.textContent = listsCount || '–'; }catch(_){}}
</script>
</body>
</html>
